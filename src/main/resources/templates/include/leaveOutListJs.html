<script th:fragment="js" type="text/javascript">


  $(document).ready(function() {
    console.log('DOCUMENT READY!!');

    initEvent();

  });


  function initEvent() {
    console.log("initEvent() CALLED!!!");

    $("a.modifyLeavePass").on('click', function (){
        console.log("modifyLeavePass CLICK HANDLER()!!!!");

        let no = $(this).data("no");

        location.href = "/admin/leavePass/modifyLeavePass?no="+no;

    });
    $("a.approveLeavePass").on('click', function (){
        console.log("approveLeavePass CLICK HANDLER()!!!!");

        let no = $(this).data("no");

        ajax_approveLeavePass(no);

    });
    $("a.sendMessage").on('click', function (){
        console.log("sendMessage CLICK HANDLER()!!!!");

        let parent_phone = $(this).data("parent_phone");

        ajax_sendMessage(parent_phone);

    });
  }



  // AJAX START

  function ajax_approveLeavePass(no){
      console.log("ajax_approveLeavePass() CALLED!!!");

      msgDto={
          'no': no,
      }

      $.ajax({
          url: '/leavePass/approveLeavePass',
          type: 'GET',
          data: msgDto,
          contentType: 'application/json; charset=utf-8',
          dataType: 'json',
          success: function(data) {
              console.log('AJAX SUCCESS - ajax_approveLeavePass()');

              let leavePassDtos = data.leavePassDtos;

              let appendTag = "";
              $("#sectionWrap  table > tbody").children().remove();
              for (let i = 0; i < leavePassDtos.length; i++){
                  appendTag += "<tr>";
                  appendTag += "<td>" + leavePassDtos[i].student_name + "</td>";
                  appendTag += "<td>" + leavePassDtos[i].student_id + "</td>";
                  appendTag += "<td>" + leavePassDtos[i].grade + "</td>";
                  appendTag += "<td>" + leavePassDtos[i].dormitory + "</td>";
                  appendTag += "<td>" + leavePassDtos[i].content + "</td>";
                  appendTag += "<td>" + leavePassDtos[i].start_date + "</td>";
                  appendTag += "<td>" + leavePassDtos[i].start_date + "</td>";
                  appendTag += "<td>" + leavePassDtos[i].end_date + "</td>";
                  appendTag += "<td<a class='modifyLeavePass' href='#none' data-no=" + leavePassDtos[i].no + ">수정</a></td>";
                  if(leavePassDtos.admin_approval == '0'){
                      appendTag += "<td><a class='approveLeavePass' href='#none' data-no="+leavePassDtos[i].no+">승인</a></td>";
                  } else {
                      appendTag += "<td>승인완료</td>";
                  }
                  appendTag += "</tr>";
              }
              $("#sectionWrap table > tbody").append(appendTag);


          },
          error: function(data) {
              console.log('AJAX ERROR - ajax_approveLeavePass()');
          }
      });
  }

  function ajax_sendMessage(parent_phone) {
      console.log("ajax_sendMessage() CALLED!!!");

      msgDto={
          'to': parent_phone,
          'content': '학생이 복귀했습니다.',
      }

      $.ajax({
          url: '/sms/sendMessages',
          type: 'POST',
          data: msgDto,
          contentType: 'application/json; charset=utf-8',
          dataType: 'json',
          success: function(data) {
              console.log('AJAX SUCCESS - ajax_sendMessage()');

              let response  = data.response;
              console.log(response.statusCode);

              if(response.statusCode == '202'){
                  alert("메시지를 발송하였습니다.");
              }else {
                  alert("메시지 전송에 실패하였습니다.");
              }

              //
              // let leavePassDtos = data.leavePassDtos;
              //
              // let appendTag = "";
              // $("#sectionWrap  table > tbody").children().remove();
              // for (let i = 0; i < leavePassDtos.length; i++){
              //     appendTag += "<tr>";
              //     appendTag += "<td>" + leavePassDtos[i].student_name + "</td>";
              //     appendTag += "<td>" + leavePassDtos[i].student_id + "</td>";
              //     appendTag += "<td>" + leavePassDtos[i].grade + "</td>";
              //     appendTag += "<td>" + leavePassDtos[i].dormitory + "</td>";
              //     appendTag += "<td>" + leavePassDtos[i].content + "</td>";
              //     appendTag += "<td>" + leavePassDtos[i].start_date + "</td>";
              //     appendTag += "<td>" + leavePassDtos[i].start_date + "</td>";
              //     appendTag += "<td>" + leavePassDtos[i].end_date + "</td>";
              //     appendTag += "<td<a class='modifyLeavePass' href='#none' data-no=" + leavePassDtos[i].no + ">수정</a></td>";
              //     if(leavePassDtos.admin_approval == '0'){
              //         appendTag += "<td><a class='approveLeavePass' href='#none' data-no="+leavePassDtos[i].no+">승인</a></td>";
              //     } else {
              //         appendTag += "<td>승인완료</td>";
              //     }
              //     appendTag += "<td<a class='sendMessage' href='#none' data-parent_phone=" + leavePassDtos[i].parent_phone + ">복귀</a></td>";
              //     appendTag += "</tr>";
              // }
              // $("#sectionWrap table > tbody").append(appendTag);


          },
          error: function(data) {
              console.log('AJAX ERROR - ajax_sendMessage()');
          }
      });
  }
</script>